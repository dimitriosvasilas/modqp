FROM centos:centos7 AS stage0
WORKDIR /opt/
RUN set -xe && \
  yum install gcc wget libaio numactl-libs openssl -y && yum -y clean all && \
  wget https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.20-linux-x86_64-minimal.tar.xz && \
  tar xvf mysql-8.0.20-linux-x86_64-minimal.tar.xz && \
  rm mysql-8.0.20-linux-x86_64-minimal.tar.xz

FROM stage0 AS stage1
WORKDIR /usr/local/
RUN set -xe && \
    groupadd mysql && \
    useradd -r -g mysql -s /bin/false mysql && \
    chown -R mysql:mysql /opt/mysql-8.0.20-linux-x86_64-minimal && \
    ln -s /opt/mysql-8.0.20-linux-x86_64-minimal mysql && \
    mkdir mysql-files && \
    chown mysql:mysql mysql-files && \
    chmod 750 mysql-files

FROM stage1 AS stage2
WORKDIR /usr/local/mysql/
COPY build/datastore/lobsters-MySQL/ /opt/lobsters/
ARG MYSQL_PASSWORD
RUN set -xe && \
    bin/mysqld --initialize --user=mysql &> log && \
    export OLDPASS=$(cat log | grep password | awk '{print $NF}') && \
    bin/mysql_ssl_rsa_setup && \
    support-files/mysql.server start && \
    cp /opt/lobsters/cred.cnf /tmp/cred1.cnf && \
    echo "" >> /tmp/cred1.cnf && echo "" >> /opt/lobsters/cred.cnf && \
    echo "password=$OLDPASS" >> /tmp/cred1.cnf && \
    echo "password=$MYSQL_PASSWORD" >> /opt/lobsters/cred.cnf && \
    echo "ALTER USER 'root'@'localhost' IDENTIFIED BY '$MYSQL_PASSWORD';" > /tmp/changepass.sql && \
    echo "CREATE USER 'user'@'%' IDENTIFIED BY '$MYSQL_PASSWORD';" > /tmp/adduser.sql && \
    echo "GRANT ALL ON *.* TO 'user'@'%';" >> /tmp/adduser.sql && \
    echo "flush privileges;" >> /tmp/adduser.sql && \
    cat /tmp/adduser.sql && \
    cat /opt/lobsters/cred.cnf && \
    cat /tmp/cred1.cnf && \
    bin/mysql --defaults-extra-file=/tmp/cred1.cnf --connect-expired-password < /tmp/changepass.sql && \
    bin/mysql --defaults-extra-file=/opt/lobsters/cred.cnf < /tmp/adduser.sql && \
    /usr/local/mysql/bin/mysql --defaults-extra-file=/opt/lobsters/cred.cnf  < /opt/lobsters/schema-plain.sql && \
    /usr/local/mysql/support-files/mysql.server stop

CMD ["/opt/lobsters/start.sh"]