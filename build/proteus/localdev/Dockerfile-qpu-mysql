# to build
# docker build -f build/localdev/Dockerfile-qpu-mysql -t qpu/dev .
# to run
# docker run --rm -ti --name <name> -p 127.0.0.1:<port>:<port> -e MYSQL_ROOT_PASSWORD=<password> qpu/dev /etc/<path-to-conf> <log-level>

FROM mysql

WORKDIR /tmp

RUN set -xe && \
    apt-get update -y && \
    apt-get install -y build-essential curl netcat && \
    curl -O https://storage.googleapis.com/golang/go1.14.2.linux-amd64.tar.gz && \
    tar -xvf go1.14.2.linux-amd64.tar.gz && \
    chown -R root:root ./go && \
    mv go /usr/local && \
    mkdir ${HOME}/go


ENV GOPATH="${HOME}/go"
ENV PATH="${PATH}:/usr/local/go/bin:${GOPATH}/bin"
ENV GO111MODULE=on

WORKDIR /

COPY go.mod .
COPY go.sum .

RUN go mod download

WORKDIR /app/proteus/
COPY . .

COPY ./configs /etc

RUN set -xe && \
    make qpu

COPY ./build/localdev/start.sh /

ENTRYPOINT ["/start.sh"]